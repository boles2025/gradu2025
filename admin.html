<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - طلبات الخريجين</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #6a11cb; --secondary: #2575fc; --accent: #00d4ff;
            --success: #2ecc71; --danger: #e74c3c; --warning: #f39c12;
            --dark-blue: #2c3e50; --dark-grey: #34495e;
            --shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: #f4f7fc; direction: rtl; }
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 24px; }
        .nav { background-color: #ffffff; padding: 10px; display: flex; justify-content: center; gap: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .nav a { color: #333; text-decoration: none; padding: 8px 15px; border-radius: 50px; transition: all 0.3s; font-weight: 600; }
        .nav a:hover { background-color: #f0f0f0; color: var(--primary); }
        .nav a.active { background: var(--primary); color: white; }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; }
        .card { background-color: white; border-radius: 12px; box-shadow: var(--shadow); padding: 25px; margin-bottom: 25px; }
        .card-title { color: var(--primary); margin: 0 0 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 20px; border-radius: 12px; color: white; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; position: relative; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .stat-card .stat-icon { position: absolute; left: -10px; top: -10px; font-size: 5rem; opacity: 0.1; transform: rotate(-15deg); }
        .stat-card h3 { margin: 0 0 10px; font-size: 1rem; }
        .stat-card p { margin: 0; font-size: 2.5rem; font-weight: 700; }
        .stat-card.total { background: linear-gradient(135deg, #6a11cb, #2575fc); }
        .stat-card.pending { background: linear-gradient(135deg, #f39c12, #f1c40f); }
        .stat-card.cancelled { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stat-card.completed { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .stat-card.delivered { background: linear-gradient(135deg, var(--dark-blue), var(--dark-grey)); }
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .filter-group input, .filter-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Cairo', sans-serif; }
        .btn { padding: 8px 15px; border: none; border-radius: 8px; font-family: 'Cairo', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn i { transition: transform 0.3s; }
        .btn:hover:not(:disabled) i { transform: scale(1.1); }
        .btn-primary { background-color: var(--secondary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-warning { background-color: var(--warning); color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background-color: #f8f9fa; font-weight: 700; color: #333; }
        tr:hover { background-color: #f8f9fa; }
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; }
        .badge-warning { background-color: #fff3e0; color: var(--warning); }
        .badge-danger { background-color: #ffebee; color: var(--danger); }
        .actions-cell { display: flex; gap: 5px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border-radius: 12px; width: 90%; max-width: 900px; animation: slideIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .modal-title { margin: 0; color: var(--primary); font-size: 22px; }
        .close-modal { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .close-modal:hover { color: #333; }
        .receipt-thumbnail { width: 80px; height: 80px; object-fit: cover; margin: 5px; cursor: pointer; border: 2px solid #ddd; border-radius: 8px; transition: transform 0.3s; }
        .receipt-thumbnail:hover { transform: scale(1.1); }
        #statsListContainer { max-height: 60vh; overflow-y: auto; margin-top: 15px; }
        .stats-list-item { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.3s; }
        .stats-list-item:hover { background-color: #f8f9fa; }
        .stats-list-item-name { font-weight: bold; color: var(--primary); }
        .stats-list-item-details { color: #666; font-size: 0.9em; display: flex; flex-direction: column; gap: 4px; margin-top: 5px; }
        .stats-list-item-details span { display: block; }
        .stats-list-item-date { font-weight: bold; color: #333; }
        footer {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(90deg, var(--accent), white, var(--primary), var(--secondary));
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -moz-background-clip: text;
            -webkit-text-fill-color: transparent; 
            -moz-text-fill-color: transparent;
            animation: gradient-animation 5s ease infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body>
    <div class="header"><h1>لوحة تحكم طلبات الخريجين</h1></div>
    
    <div class="nav">
        <a href="admin.html" class="active"><i class="fas fa-list"></i> الطلبات الحالية</a>
        <a href="completed.html"><i class="fas fa-check-circle"></i> المكتملة والتسليم</a>
        <a href="settings.html"><i class="fas fa-cog"></i> الإعدادات</a>
    </div>
    
    <div class="container">
        <div class="stats-container">
            <div class="stat-card total" id="totalRequestsCard"> <i class="fas fa-list-alt stat-icon"></i> <h3>إجمالي الطلبات الحالية</h3> <p id="totalRequests">0</p> </div>
            <div class="stat-card pending" id="pendingRequestsCard"> <i class="fas fa-clock stat-icon"></i> <h3>قيد التنفيذ</h3> <p id="pendingRequests">0</p> </div>
            <div class="stat-card cancelled" id="cancelledRequestsCard"> <i class="fas fa-times-circle stat-icon"></i> <h3>طلبات ملغاة</h3> <p id="cancelledRequests">0</p> </div>
            <div class="stat-card completed" id="completedRequestsCard"> <i class="fas fa-check-double stat-icon"></i> <h3>جاهزة للتسليم</h3> <p id="completedRequests">0</p> </div>
            <div class="stat-card delivered" id="deliveredRequestsCard"> <i class="fas fa-handshake stat-icon"></i> <h3>تم تسليمها</h3> <p id="deliveredRequests">0</p> </div>
        </div>
        
        <div class="card">
            <h2 class="card-title">فلترة الطلبات الحالية</h2>
            <div class="filters">
                <div class="filter-group"><input type="date" id="filterDate" class="filter-input" title="فلترة حسب التاريخ"></div>
                <div class="filter-group">
                    <select id="filterStatus" class="filter-input" title="فلترة حسب الحالة"><option value="all">كل الحالات</option><option value="pending">قيد التنفيذ</option><option value="cancelled">ملغاة</option></select>
                </div>
                <div class="filter-group"><select id="filterGraduationYear" class="filter-input" title="فلترة حسب سنة التخرج"><option value="all">كل السنوات</option></select></div>
                <div class="filter-group"><input type="text" id="search" placeholder="ابحث بالاسم أو الرقم القومي..." class="filter-input"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-title">
                <h2>قائمة الطلبات الحالية</h2>
                <div>
                    <button id="exportExcel" class="btn btn-success"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                    <button id="downloadAllReceiptsBtn" class="btn btn-info"><i class="fas fa-download"></i> تحميل كل الإيصالات</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table id="requestsTable">
                    <thead><tr><th>رقم الطلب</th><th>اسم الخريج</th><th>سنة التخرج</th><th>الخدمات</th><th>تاريخ الطلب</th><th>الحالة</th><th>إجراءات</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="modal" id="requestModal"><div class="modal-content" id="requestModalContent"></div></div>
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title" id="statsModalTitle"></h3><span class="close-modal">&times;</span></div>
            <div id="statsListContainer"></div>
        </div>
    </div>

    <footer> تصميم وتطوير: المهندس بولس سمير </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBtLojF4wpmpDua3UZa_GzlaXhTxM2ediI", authDomain: "gradu-ae76f.firebaseapp.com", databaseURL: "https://gradu-ae76f-default-rtdb.firebaseio.com", projectId: "gradu-ae76f" };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentRequests = [], completedRequests = [], deliveredRequests = [];
        let deliverySettings = { deliveryDays: 15 };

        function initGraduationYearFilter() {
            const select = document.getElementById('filterGraduationYear');
            for (let year = new Date().getFullYear(); year >= 2014; year--) select.innerHTML += `<option value="${year}">${year}</option>`;
        }
        
        function fetchAllData() {
            db.ref('settings').once('value', snapshot => { if (snapshot.exists()) deliverySettings = snapshot.val(); });
            db.ref('requests').on('value', snapshot => {
                currentRequests = [];
                if (snapshot.exists()) snapshot.forEach(child => currentRequests.push({ id: child.key, ...child.val(), source: 'current' }));
                currentRequests.sort((a, b) => b.timestamp - a.timestamp);
                applyFilters();
                updateStats();
            });
            db.ref('completed_requests').on('value', snapshot => {
                completedRequests = [];
                if (snapshot.exists()) snapshot.forEach(child => completedRequests.push({ id: child.key, ...child.val(), source: 'completed' }));
                updateStats();
            });
            db.ref('delivered_requests').on('value', snapshot => {
                deliveredRequests = [];
                if (snapshot.exists()) snapshot.forEach(child => deliveredRequests.push({ id: child.key, ...child.val(), source: 'delivered' }));
                updateStats();
            });
        }
        
        function getFilteredRequests() {
            const dateFilter = document.getElementById('filterDate').value, statusFilter = document.getElementById('filterStatus').value;
            const yearFilter = document.getElementById('filterGraduationYear').value, searchQuery = document.getElementById('search').value.toLowerCase();
            return currentRequests.filter(req => {
                const reqDate = new Date(req.timestamp).toISOString().split('T')[0];
                return (!dateFilter || reqDate === dateFilter) && (statusFilter === 'all' || req.status === statusFilter) &&
                       (yearFilter === 'all' || req.graduationYear == yearFilter) &&
                       (!searchQuery || (req.name && req.name.toLowerCase().includes(searchQuery)) || (req.nationalId && req.nationalId.includes(searchQuery)));
            });
        }

        function applyFilters() { renderRequests(getFilteredRequests()); }
        
        function renderRequests(requests) {
            const tableBody = document.querySelector('#requestsTable tbody');
            tableBody.innerHTML = requests.length === 0 ? '<tr><td colspan="7" style="text-align: center; padding: 1rem;">لا توجد طلبات تطابق الفلتر</td></tr>' : '';
            requests.forEach(req => {
                const servicesStr = (req.services || []).map(s => `${s.name}(${s.quantity})`).join('، ');
                const dateStr = new Date(req.timestamp).toLocaleDateString('ar-EG');
                const statusBadge = req.status === 'pending' ? '<span class="badge badge-warning">قيد التنفيذ</span>' : '<span class="badge badge-danger">ملغى</span>';
                tableBody.innerHTML += `
                    <tr>
                        <td>${req.id.substring(1, 8)}</td> <td>${req.name}</td> <td>${req.graduationYear}</td>
                        <td>${servicesStr}</td> <td>${dateStr}</td> <td>${statusBadge}</td>
                        <td class="actions-cell">
                            <button class="btn btn-primary" onclick="viewRequestDetails('${req.id}')" title="عرض التفاصيل"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-success" onclick="completeRequest('${req.id}')" title="نقل للمكتملة (طباعة)"><i class="fas fa-check"></i></button>
                            <button class="btn btn-warning" onclick="downloadStudentReceipts('${req.id}')" title="تحميل إيصالات الخريج"><i class="fas fa-file-archive"></i></button>
                            <button class="btn btn-danger" onclick="deleteRequest('${req.id}')" title="حذف نهائي"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        function updateStats() {
            document.getElementById('totalRequests').textContent = currentRequests.length;
            document.getElementById('pendingRequests').textContent = currentRequests.filter(r => r.status === 'pending').length;
            document.getElementById('cancelledRequests').textContent = currentRequests.filter(r => r.status === 'cancelled').length;
            document.getElementById('completedRequests').textContent = completedRequests.length;
            document.getElementById('deliveredRequests').textContent = deliveredRequests.length;
            document.getElementById('totalRequestsCard').onclick = () => showStatsModal('إجمالي الطلبات الحالية', currentRequests);
            document.getElementById('pendingRequestsCard').onclick = () => showStatsModal('طلبات قيد التنفيذ', currentRequests.filter(r => r.status === 'pending'));
            document.getElementById('cancelledRequestsCard').onclick = () => showStatsModal('طلبات ملغاة', currentRequests.filter(r => r.status === 'cancelled'));
            document.getElementById('completedRequestsCard').onclick = () => showStatsModal('طلبات جاهزة للتسليم', completedRequests);
            document.getElementById('deliveredRequestsCard').onclick = () => showStatsModal('طلبات تم تسليمها', deliveredRequests);
        }
        
        async function viewRequestDetails(id) {
            const req = [...currentRequests, ...completedRequests, ...deliveredRequests].find(r => r.id === id);
            if (!req) { alert('لم يتم العثور على الطلب!'); return; }
            if (req.source === 'current' && !req.reviewedAt) { db.ref(`requests/${id}/reviewedAt`).set(Date.now()); }
            document.getElementById('requestModalContent').innerHTML = `
                <div class="modal-header"><h3 class="modal-title">تفاصيل طلب: ${req.name}</h3><span class="close-modal" onclick="closeModal('requestModal')">&times;</span></div>
                <div style="padding: 15px 0;">
                    <p><strong>الرقم القومي:</strong> ${req.nationalId || 'غير متوفر'}</p>
                    <p><strong>الهاتف:</strong> ${req.phone || 'غير متوفر'} | <strong>واتساب:</strong> ${req.whatsapp || 'غير متوفر'} | <strong>الإيميل:</strong> ${req.email || 'غير متوفر'}</p>
                    <p><strong>الخدمات:</strong> ${(req.services || []).map(s => `${s.name} (x${s.quantity})`).join(', ')}</p>
                    <p><strong>إيصالات الدفع:</strong></p>
                    <div>${(req.services || []).map(s => s.receiptUrl ? `<a href="${s.receiptUrl}" target="_blank"><img src="${s.receiptUrl}" class="receipt-thumbnail"></a>` : '').join('') || 'لا توجد إيصالات'}</div>
                </div>`;
            openModal('requestModal');
        }

        async function completeRequest(id) {
            if (!confirm("هل أنت متأكد؟ سيتم نقل الطلب إلى قائمة الطلبات المكتملة.")) return;
            const snap = await db.ref(`requests/${id}`).once('value');
            if (snap.exists()) {
                const reqData = snap.val();
                reqData.status = 'completed'; reqData.completedAt = Date.now();
                await db.ref(`completed_requests/${id}`).set(reqData);
                await db.ref(`requests/${id}`).remove();
                alert("تم نقل الطلب بنجاح.");
            }
        }

        async function deleteRequest(id) {
            if (!confirm("تحذير! هل أنت متأكد من حذف هذا الطلب بشكل نهائي؟")) return;
            await db.ref(`requests/${id}`).remove();
            alert("تم حذف الطلب بنجاح.");
        }
        
        function showStatsModal(title, requests) {
            document.getElementById('statsModalTitle').textContent = `${title} (${requests.length})`;
            const listContainer = document.getElementById('statsListContainer');
            listContainer.innerHTML = requests.length === 0 ? '<p style="text-align:center;color:#888;padding:20px;">لا توجد بيانات لعرضها.</p>' : '';
            requests.forEach(req => {
                const servicesStr = (req.services || []).map(s => s.name).join('، ');
                const deliveryDate = new Date(req.timestamp);
                deliveryDate.setDate(deliveryDate.getDate() + (parseInt(deliverySettings.deliveryDays) || 15));
                const deliveryDateStr = deliveryDate.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
                listContainer.innerHTML += `
                    <div class="stats-list-item" onclick="closeModal('statsModal'); viewRequestDetails('${req.id}');">
                        <div>
                            <div class="stats-list-item-name">${req.name}</div>
                            <div class="stats-list-item-details">
                                <span><strong>الرقم القومي:</strong> ${req.nationalId || 'N/A'}</span>
                                <span><strong>الخدمات:</strong> ${servicesStr || 'غير محدد'}</span>
                                <span><strong>تاريخ التسليم المتوقع:</strong> ${deliveryDateStr}</span>
                            </div>
                        </div>
                        <div class="stats-list-item-date">${new Date(req.timestamp).toLocaleDateString('ar-EG')}</div>
                    </div>`;
            });
            openModal('statsModal');
        }

        function exportToExcel() {
            const btn = document.getElementById('exportExcel'), originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ التصدير...'; btn.disabled = true;
            const filtered = getFilteredRequests();
            if (filtered.length === 0) { alert("لا توجد بيانات للتصدير."); btn.innerHTML = originalText; btn.disabled = false; return; }
            const data = filtered.map(req => {
                const deliveryDate = new Date(req.timestamp);
                deliveryDate.setDate(deliveryDate.getDate() + (parseInt(deliverySettings.deliveryDays) || 15));
                return {
                    'رقم الطلب': `'${req.id.substring(1, 8)}`, 'اسم الخريج': req.name, 'الرقم القومي': `'${req.nationalId}`,
                    'سنة التخرج': req.graduationYear, 'الخدمات': (req.services || []).map(s => `${s.name}(${s.quantity})`).join('، '),
                    'تاريخ الطلب': new Date(req.timestamp).toLocaleDateString('ar-EG'), 'تاريخ التسليم المتوقع': deliveryDate.toLocaleDateString('ar-EG'),
                    'الحالة': req.status === 'pending' ? 'قيد التنفيذ' : 'ملغى'
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الطلبات الحالية");
            XLSX.writeFile(wb, "طلبات_الخريجين_الحالية.xlsx");
            btn.innerHTML = originalText; btn.disabled = false;
        }

        async function downloadReceipts(requests, btnId, fileName) {
            const btn = document.getElementById(btnId), originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جارٍ التجهيز...'; btn.disabled = true;
            if (requests.length === 0) { alert("لا توجد طلبات لتحميل إيصالاتها."); btn.innerHTML = originalText; btn.disabled = false; return; }
            const zip = new JSZip();
            let count = 0;
            const promises = [];
            for (const req of requests) {
                for (const service of req.services || []) {
                    if (service.receiptUrl) {
                        count++;
                        const promise = fetch(service.receiptUrl, { mode: 'cors' }).then(res => res.blob()).then(blob => {
                            zip.file(`${req.name}_${req.nationalId}_${service.name}.jpg`, blob);
                        }).catch(e => console.error(`فشل تحميل إيصال: ${service.receiptUrl}`, e));
                        promises.push(promise);
                    }
                }
            }
            if (count === 0) { alert("لا توجد إيصالات متاحة للتحميل في الطلبات المحددة."); btn.innerHTML = originalText; btn.disabled = false; return; }
            await Promise.all(promises);
            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content); link.download = fileName;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            btn.innerHTML = originalText; btn.disabled = false;
        }
        
        async function downloadStudentReceipts(id) {
            const req = currentRequests.find(r => r.id === id);
            if (!req) return;
            await downloadReceipts([req], `requestsTable`, `${req.name}_${req.graduationYear}_إيصالات.zip`);
        }

        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        document.querySelectorAll('.close-modal').forEach(btn => btn.onclick = () => closeModal(btn.closest('.modal').id));
        window.onclick = (event) => { if (event.target.classList.contains('modal')) closeModal(event.target.id); };
        
        document.getElementById('exportExcel').addEventListener('click', exportToExcel);
        document.getElementById('downloadAllReceiptsBtn').addEventListener('click', () => downloadReceipts(getFilteredRequests(), 'downloadAllReceiptsBtn', 'إيصالات_الطلبات_المفلترة.zip'));
        document.querySelectorAll('.filter-input').forEach(input => input.addEventListener('input', applyFilters));
        
        initGraduationYearFilter();
        fetchAllData();
    </script>
</body>
</html>